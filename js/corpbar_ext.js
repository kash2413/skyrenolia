!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/build/",r(r.s="bcKa")}({"0/Wv":function(e,t,r){window,e.exports=function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=4)}([function(e,t,r){var o,n,i;
/*!
 * JavaScript Cookie v2.2.1
 * https://github.com/js-cookie/js-cookie
 *
 * Copyright 2006, 2015 Klaus Hartl & Fagner Brack
 * Released under the MIT license
 */i=function(){function e(){for(var e=0,t={};e<arguments.length;e++){var r=arguments[e];for(var o in r)t[o]=r[o]}return t}function t(e){return e.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}return function r(o){function n(){}function i(t,r,i){if("undefined"!=typeof document){"number"==typeof(i=e({path:"/"},n.defaults,i)).expires&&(i.expires=new Date(1*new Date+864e5*i.expires)),i.expires=i.expires?i.expires.toUTCString():"";try{var a=JSON.stringify(r);/^[\{\[]/.test(a)&&(r=a)}catch(e){}r=o.write?o.write(r,t):encodeURIComponent(String(r)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),t=encodeURIComponent(String(t)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var s="";for(var u in i)i[u]&&(s+="; "+u,!0!==i[u]&&(s+="="+i[u].split(";")[0]));return document.cookie=t+"="+r+s}}function a(e,r){if("undefined"!=typeof document){for(var n={},i=document.cookie?document.cookie.split("; "):[],a=0;a<i.length;a++){var s=i[a].split("="),u=s.slice(1).join("=");r||'"'!==u.charAt(0)||(u=u.slice(1,-1));try{var c=t(s[0]);if(u=(o.read||o)(u,c)||t(u),r)try{u=JSON.parse(u)}catch(e){}if(n[c]=u,e===c)break}catch(e){}}return e?n[e]:n}}return n.set=i,n.get=function(e){return a(e,!1)},n.getJSON=function(e){return a(e,!0)},n.remove=function(t,r){i(t,"",e(r,{expires:-1}))},n.defaults={},n.withConverter=r,n}((function(){}))},void 0===(n="function"==typeof(o=i)?o.call(t,r,t,e):o)||(e.exports=n),e.exports=i()},function(e,t,r){(function(r){var o;!function(r,n){e.exports=function(r){"use strict";var n,i=(r=r||{}).Base64,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=function(e){for(var t={},r=0,o=e.length;r<o;r++)t[e.charAt(r)]=r;return t}(a),u=String.fromCharCode,c=function(e){if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?u(192|t>>>6)+u(128|63&t):u(224|t>>>12&15)+u(128|t>>>6&63)+u(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return u(240|t>>>18&7)+u(128|t>>>12&63)+u(128|t>>>6&63)+u(128|63&t)},l=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,h=function(e){return e.replace(l,c)},f=function(e){var t=[0,2,1][e.length%3],r=e.charCodeAt(0)<<16|(e.length>1?e.charCodeAt(1):0)<<8|(e.length>2?e.charCodeAt(2):0);return[a.charAt(r>>>18),a.charAt(r>>>12&63),t>=2?"=":a.charAt(r>>>6&63),t>=1?"=":a.charAt(63&r)].join("")},p=r.btoa&&"function"==typeof r.btoa?function(e){return r.btoa(e)}:function(e){if(e.match(/[^\x00-\xFF]/))throw new RangeError("The string contains invalid characters.");return e.replace(/[\s\S]{1,3}/g,f)},d=function(e){return p(h(String(e)))},g=function(e){return e.replace(/[+\/]/g,(function(e){return"+"==e?"-":"_"})).replace(/=/g,"")},m=function(e,t){return t?g(d(e)):d(e)};r.Uint8Array&&(n=function(e,t){for(var r="",o=0,n=e.length;o<n;o+=3){var i=e[o],s=e[o+1],u=e[o+2],c=i<<16|s<<8|u;r+=a.charAt(c>>>18)+a.charAt(c>>>12&63)+(void 0!==s?a.charAt(c>>>6&63):"=")+(void 0!==u?a.charAt(63&c):"=")}return t?g(r):r});var y,b=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,w=function(e){switch(e.length){case 4:var t=((7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3))-65536;return u(55296+(t>>>10))+u(56320+(1023&t));case 3:return u((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return u((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},v=function(e){return e.replace(b,w)},_=function(e){var t=e.length,r=t%4,o=(t>0?s[e.charAt(0)]<<18:0)|(t>1?s[e.charAt(1)]<<12:0)|(t>2?s[e.charAt(2)]<<6:0)|(t>3?s[e.charAt(3)]:0),n=[u(o>>>16),u(o>>>8&255),u(255&o)];return n.length-=[0,0,2,1][r],n.join("")},P=r.atob&&"function"==typeof r.atob?function(e){return r.atob(e)}:function(e){return e.replace(/\S{1,4}/g,_)},O=function(e){return P(String(e).replace(/[^A-Za-z0-9\+\/]/g,""))},C=function(e){return String(e).replace(/[-_]/g,(function(e){return"-"==e?"+":"/"})).replace(/[^A-Za-z0-9\+\/]/g,"")},T=function(e){return function(e){return v(P(e))}(C(e))};if(r.Uint8Array&&(y=function(e){return Uint8Array.from(O(C(e)),(function(e){return e.charCodeAt(0)}))}),r.Base64={VERSION:"2.6.4",atob:O,btoa:p,fromBase64:T,toBase64:m,utob:h,encode:m,encodeURI:function(e){return m(e,!0)},btou:v,decode:T,noConflict:function(){var e=r.Base64;return r.Base64=i,e},fromUint8Array:n,toUint8Array:y},"function"==typeof Object.defineProperty){var j=function(e){return{value:e,enumerable:!1,writable:!0,configurable:!0}};r.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",j((function(){return T(this)}))),Object.defineProperty(String.prototype,"toBase64",j((function(e){return m(this,e)}))),Object.defineProperty(String.prototype,"toBase64URI",j((function(){return m(this,!0)})))}}return r.Meteor&&(Base64=r.Base64),e.exports?e.exports.Base64=r.Base64:void 0===(o=function(){return r.Base64}.apply(t,[]))||(e.exports=o),{Base64:r.Base64}}(r)}("undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==r?r:this)}).call(this,r(3))},function(e,t,r){"use strict";var o;e.exports.timeout=function(e,t){var r,n=new o;return Promise.race([e,new Promise((function(e,o){r=setTimeout((function(){o(n)}),t)}))]).then((function(e){return clearTimeout(r),e}),(function(e){throw clearTimeout(r),e}))},(o=e.exports.TimeoutError=function(){Error.call(this),this.stack=Error().stack,this.message="Timeout"}).prototype=Object.create(Error.prototype),o.prototype.name="TimeoutError"},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){"use strict";r.r(t),r.d(t,"Central",(function(){return X})),r.d(t,"User",(function(){return u})),r.d(t,"ConsoleLogger",(function(){return K})),r.d(t,"UserData",(function(){return S}));var o,n=(o=function(e,t){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="CentralError",o}return n(t,e),t}(Error),a=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),s=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="InvalidRoleError",o}return a(t,e),t}(i),u=function(){function e(e,t,r,o){this._email=null,this._confirmed=null,this._subscriptionRoles=new Map,this._id=e,this._email=t,this._confirmed=r,this._subscriptionRoles=o}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"email",{get:function(){return this._email},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"confirmed",{get:function(){return this._confirmed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscriptionRoles",{get:function(){return this._subscriptionRoles},enumerable:!1,configurable:!0}),e.prototype.hasSubscriptionRole=function(e){return this.subscriptionRoles.has(e)},e.prototype.hasActiveSubscriptionRole=function(e){if(!this.hasSubscriptionRole(e))return!1;var t=this.getSubscriptionRole(e);return!t.isExpired()&&!t.deviceLimitReached},e.prototype.hasActiveSubscriptionRoles=function(e){var t=this;return e.every((function(e){return t.hasActiveSubscriptionRole(e)}))},e.prototype.getSubscriptionRole=function(e){if(!this.hasSubscriptionRole(e))throw new s('Subscription role with name "'+e+'" does not exist.');return this.subscriptionRoles.get(e)},e}(),c=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),l=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o._apiResponse=null,o.stack=new Error(t[0]).stack,o.name="TokenLoadFailedError",o}return c(t,e),Object.defineProperty(t.prototype,"apiResponse",{get:function(){return this._apiResponse},set:function(e){this._apiResponse=e},enumerable:!1,configurable:!0}),t}(i),h=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),f=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="InvalidJsonError",o}return h(t,e),t}(l),p=function(){function e(){}return e.toInt=function(e){if(/^[-+]?(\d+|Infinity)$/.test(e)){var t=Number(e);if(isNaN(t))throw new i('"'+e+'" is not valid integer.');return t}throw new i('"'+e+'" is not valid integer.')},e.isInt=function(t){try{return e.toInt(t),!0}catch(e){return!1}},e.parseJson=function(e){try{return JSON.parse(e)}catch(e){throw new f(e.message)}},e}(),d=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),g=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="TokenUpdateTimeoutError",o}return d(t,e),t}(l),m=function(){function e(e,t,r){void 0===r&&(r=!1),this._deviceLimitReached=!1,this._name=e,this._expireAt=t,this._deviceLimitReached=r}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"expireAt",{get:function(){return this._expireAt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"deviceLimitReached",{get:function(){return this._deviceLimitReached},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ttl",{get:function(){var e=new Date,t=Math.floor((this._expireAt.getTime()-e.getTime())/1e3);return 0>t?0:t},enumerable:!1,configurable:!0}),e.prototype.isExpired=function(){return this.ttl<=0},e}(),y=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),b=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="TokenInvalidError",o}return y(t,e),t}(l),w=function(){function e(e,t,r,o,n,i,a,s){this._email=null,this._confirmed=null,this._subscriptionRoles=new Map,this._id=e,this._subject=t,this._issuedAt=r,this._expireAt=o,this._audience=n,this._email=i,this._confirmed=a,this._subscriptionRoles=s}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subject",{get:function(){return this._subject},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"issuedAt",{get:function(){return this._issuedAt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"expireAt",{get:function(){return this._expireAt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"audience",{get:function(){return this._audience},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"email",{get:function(){return this._email},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"confirmed",{get:function(){return this._confirmed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscriptionRoles",{get:function(){return this._subscriptionRoles},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ttl",{get:function(){var e=new Date,t=Math.floor((this.expireAt.getTime()-e.getTime())/1e3);return 0>t?0:t},enumerable:!1,configurable:!0}),e.createFromUserJwtPayload=function(t){e.checkJwtPayload(t);var r=null;Object.prototype.hasOwnProperty.call(t,"eml")&&t.eml&&(r=t.eml);var o=null;Object.prototype.hasOwnProperty.call(t,"cnf")&&(o=t.cnf);var n=new Map;return Object.prototype.hasOwnProperty.call(t,"sbr")&&t.sbr&&Object.keys(t.sbr).forEach((function(e){if(t.sbr){var r=t.sbr[e],o=!1;Object.prototype.hasOwnProperty.call(r,"dlr")&&r.dlr&&(o=r.dlr),n.set(e,new m(e,new Date(1e3*r.exp),o))}})),new e(t.jti,t.sub,new Date(1e3*t.iat),new Date(1e3*t.exp),t.aud,r,o,n)},e.checkJwtPayload=function(e){["sub","iat","exp","jti","aud"].forEach((function(t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new b('The JWT token is invalid. Claim "'+t+'" is missing.')}))},e.prototype.isFresh=function(){return this.ttl>0},e}(),v=r(1),_=function(){function e(){this.logger=null}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.tokenToUserPayload=function(e){this.log("parsing...",e);var t=w.createFromUserJwtPayload(this.parseJwt(e));return this.log("UserPayload from parsed JWT created",t),t},e.prototype.parseJwt=function(e){return this.parseJson(this.base64UrlDecode(e))},e.prototype.base64UrlDecode=function(e){var t=e.split(".");if(2!==t.length)throw new b("JWT token should contain header and payload separated with dot. But "+(t.length-1)+" dots found.");try{return v.Base64.decode(t[1])}catch(e){throw new b("JWT Payload base64url decode failed with error: "+e.message)}},e.prototype.parseJson=function(e){try{return p.parseJson(e)}catch(e){throw new b("JWT Payload JSON decode failed with error: "+e.message)}},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("JwtParser",e,t)},e}(),P=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),O=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="UserNotLoggedInError",o}return P(t,e),t}(l),C=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),T=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="TokenUpdateRefusedError",o}return C(t,e),t}(l),j=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),I=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="TokenAlreadyUpdatingError",o}return j(t,e),t}(l),E=function(){function e(e,t,r){void 0===t&&(t=null),void 0===r&&(r={}),this._result=e,this._message=t,this._data=r}return Object.defineProperty(e.prototype,"result",{get:function(){return this._result},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this._message},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!1,configurable:!0}),e}(),k=r(0),A=function(){function e(e){this.userPayloadCache=null,this.userPayloadRawCache=null,this.status="init",this.plannerId=null,this.reloadPromise=null,this.lastApiCallAt=null,this.logger=null,this.config=e}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.refreshTokenAfter=function(e){var t=this;this.log("refreshTokenAfter("+e+")");var r=1e3*e,o=this.generateRandomInt(r,r+500);return this.log("randomize setTimeout("+o+")"),new Promise((function(e,r){null!==t.plannerId&&(t.log("clearing previous timeout"),clearTimeout(t.plannerId),t.plannerId=null),t.plannerId=setTimeout((function(){t.onPlannedTimeRefresh(e,r)}),o)}))},e.prototype.loadToken=function(){var e=this;return this.log("loadToken()"),new Promise((function(t,r){var o=e.parseFromCookie();o?t(o):"updating"!==e.status||null===e.reloadPromise?e.reload().then((function(e){return t(e)})).catch((function(e){return r(e)})):e.reloadPromise.then((function(r){t(r),e.reloadPromise=null})).catch((function(e){return r(e)}))}))},e.prototype.refreshToken=function(){return this.log("refreshToken()"),this.reload()},e.prototype.clearCache=function(){this.log("clearCache()"),this.userPayloadCache=null,this.userPayloadRawCache=null,this.lastApiCallAt=null},e.prototype.parseFromCookie=function(){this.log("_parseFromCookie()");var e=k.get("ppp");if(null!==this.userPayloadRawCache&&null!==this.userPayloadCache&&e===this.userPayloadRawCache&&this.userPayloadCache.isFresh())return this.log("Found userPayload in cookie, but used from inmemory cache because it`s the same and fresh"),this.userPayloadCache;if(e){if(this.userPayloadRawCache=e,!this.userPayloadRawCache)throw new i("Invalid state.");var t=new _;return t.setLogger(this.logger),this.userPayloadCache=t.tokenToUserPayload(this.userPayloadRawCache),this.userPayloadCache.isFresh()?(this.log("UserPayload in cookie accepted"),this.userPayloadCache):(this.log("UserPayload in cookie is not fresh"),null)}return this.log("No UserPayload in cookies found"),null},e.prototype.reload=function(){var e=this;return this.log("reload()"),this.reloadPromise=new Promise((function(t,r){try{e.validate(),e.status="updating";var o=new XMLHttpRequest;o.ontimeout=function(){return e.onTimeout(r)},o.onerror=function(){return e.onError(o,r)},o.onload=function(){200===o.status?e.onSuccess(o,t,r):e.onError(o,r)},e.lastApiCallAt=new Date,o.open("POST",e.config.tokenUpdateUrl+"?url="+encodeURIComponent(window.location.href),!0),o.timeout=7e3,o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Content-Type","application/json"),o.withCredentials=!0,o.send(),e.log("Ajax request to "+e.config.tokenUpdateUrl)}catch(e){r(e)}})),this.reloadPromise},e.prototype.onPlannedTimeRefresh=function(e,t){var r=this;if(this.log("Running planned refreshToken() in specific time"),this.plannerId=null,"updating"===this.status&&null!==this.reloadPromise)return this.log("token is already updating, wait for the result"),void this.reloadPromise.then((function(t){e(t),r.reloadPromise=null})).catch((function(e){return t(e)}));this.log("Refreshing token in specific time"),this.refreshToken().then((function(t){return e(t)})).catch((function(e){return t(e)}))},e.prototype.onSuccess=function(e,t,r){this.log("Ajax success");var o=e.responseText;o&&this.log("Ajax response: ",o);var n=this.parseFromCookie();if(n)return this.status="success",void t(n);this.log("JWT Cookies in response missing or were not accepted by browser."),this.status="error",r(new l("No fresh user payload found."))},e.prototype.onTimeout=function(e){this.log("Ajax failed with timeout."),this.status="timeout",e(new g("HTTP API timeout."))},e.prototype.onError=function(e,t){this.log("Ajax error. Response status code: "+e.status),this.status="error";var r=new l("HTTP API Error."),o=this.responseToApiResponse(e.responseText);o&&(r.apiResponse=o),t(r)},e.prototype.validate=function(){this.log("validating...");var e=k.get("ppu");if(!(e&&"1"===e||k.get("ppi")))throw new O("User is not logged in.");if("error"===this.status&&null!==this.lastApiCallAt){var t=new Date,r=Math.round((t.getTime()-this.lastApiCallAt.getTime())/1e3);if(this.config.waitTimeInCaseOfApiError>r)throw new T("Last API call ended with error. New API call can be done after "+(this.config.waitTimeInCaseOfApiError-r)+" seconds.")}if("timeout"===this.status&&null!==this.lastApiCallAt&&(t=new Date,r=Math.round((t.getTime()-this.lastApiCallAt.getTime())/1e3),this.config.waitTimeInCaseOfApiTimeout>r))throw new T("Last API call ended with timeout. New API call can be done after "+(this.config.waitTimeInCaseOfApiTimeout-r)+" seconds.");if("updating"===this.status)throw new I("The token is already updating.");this.log("passed")},e.prototype.responseToApiResponse=function(e){this.log("responseToApiResponse()");try{var t=this.parseJson(e);if(!Object.prototype.hasOwnProperty.call(t,"status"))throw new l('Response json does not contain expected field "status".');var r=t.status,o=null,n={};return Object.prototype.hasOwnProperty.call(t,"message")&&(o=t.message),Object.prototype.hasOwnProperty.call(t,"data")&&(n=t.data),new E(r,o,n)}catch(e){return this.log("Error: Response converting to ApiResponse failed with error:"+e.message),null}},e.prototype.parseJson=function(e){try{return p.parseJson(e)}catch(e){throw new b("Response JSON decode failed with error: "+e.message)}},e.prototype.generateRandomInt=function(e,t){return Math.floor(Math.random()*(t-e+1))+e},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("TokenLoader",e,t)},e}(),U=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),x=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="ConfigInvalidError",o}return U(t,e),t}(i),L=function(){function e(e){this._refreshBeforeExpire=!1,this._waitTimeInCaseOfApiError=120,this._waitTimeInCaseOfApiTimeout=1800,this._refreshTokenPeriodBeforeExpire=180,this._refreshOnFocus=!1,this._shareTokenLoader=!0,this._sharedIframeUrl=null,this._userDataFetchUrl=null,this._tokenUpdateUrl=e.tokenUpdateUrl,this.configureTokenLoader(e),this.configureUserDataLoader(e)}return e.prototype.configureTokenLoader=function(e){if(Object.prototype.hasOwnProperty.call(e,"waitTimeInCaseOfApiError")&&void 0!==e.waitTimeInCaseOfApiError&&(this._waitTimeInCaseOfApiError=e.waitTimeInCaseOfApiError),Object.prototype.hasOwnProperty.call(e,"waitTimeInCaseOfApiTimeout")&&void 0!==e.waitTimeInCaseOfApiTimeout&&(this._waitTimeInCaseOfApiTimeout=e.waitTimeInCaseOfApiTimeout),Object.prototype.hasOwnProperty.call(e,"refreshTokenPeriodBeforeExpire")&&void 0!==e.refreshTokenPeriodBeforeExpire){if(e.refreshTokenPeriodBeforeExpire<10)throw new x('Min config value for "refreshTokenPeriodBeforeExpire" should be 10, but '+e.refreshTokenPeriodBeforeExpire+" provided.");this._refreshTokenPeriodBeforeExpire=e.refreshTokenPeriodBeforeExpire}Object.prototype.hasOwnProperty.call(e,"refreshBeforeExpire")&&void 0!==e.refreshBeforeExpire&&(this._refreshBeforeExpire=e.refreshBeforeExpire),Object.prototype.hasOwnProperty.call(e,"refreshOnFocus")&&void 0!==e.refreshOnFocus&&(this._refreshOnFocus=e.refreshOnFocus),Object.prototype.hasOwnProperty.call(e,"shareTokenLoader")&&void 0!==e.shareTokenLoader&&(this._shareTokenLoader=e.shareTokenLoader)},e.prototype.configureUserDataLoader=function(e){Object.prototype.hasOwnProperty.call(e,"sharedIframeUrl")&&void 0!==e.sharedIframeUrl&&(this._sharedIframeUrl=e.sharedIframeUrl),Object.prototype.hasOwnProperty.call(e,"userDataFetchUrl")&&void 0!==e.userDataFetchUrl&&(this._userDataFetchUrl=e.userDataFetchUrl)},Object.defineProperty(e.prototype,"tokenUpdateUrl",{get:function(){return this._tokenUpdateUrl},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"waitTimeInCaseOfApiError",{get:function(){return this._waitTimeInCaseOfApiError},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"waitTimeInCaseOfApiTimeout",{get:function(){return this._waitTimeInCaseOfApiTimeout},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"refreshBeforeExpire",{get:function(){return this._refreshBeforeExpire},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"refreshTokenPeriodBeforeExpire",{get:function(){return this._refreshTokenPeriodBeforeExpire},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"refreshOnFocus",{get:function(){return this._refreshOnFocus},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"shareTokenLoader",{get:function(){return this._shareTokenLoader},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sharedIframeUrl",{get:function(){return this._sharedIframeUrl},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userDataFetchUrl",{get:function(){return this._userDataFetchUrl},enumerable:!1,configurable:!0}),e}(),S=function(){function e(){this._id=null,this._createdAt=null,this._email=null,this._hashedEmail=null,this._phone=null,this._subscribedNewsletters=[],this._rawData=null}return e.createFromRawData=function(t){var r=new e;return r.initWithRawData(t),r},e.prototype.initWithRawData=function(e){Object.prototype.hasOwnProperty.call(e,"central_user_id")&&(this._id=e.central_user_id),Object.prototype.hasOwnProperty.call(e,"user_created_at")&&(this._createdAt=new Date(e.user_created_at)),Object.prototype.hasOwnProperty.call(e,"email")&&(this._email=e.email),Object.prototype.hasOwnProperty.call(e,"hashed_email")&&(this._hashedEmail=e.hashed_email),Object.prototype.hasOwnProperty.call(e,"phone")&&(this._phone=e.phone),Object.prototype.hasOwnProperty.call(e,"subscribed_newsletters")&&(this._subscribedNewsletters=e.subscribed_newsletters),this._rawData=e},Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"createdAt",{get:function(){return this._createdAt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"email",{get:function(){return this._email},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hashedEmail",{get:function(){return this._hashedEmail},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"phone",{get:function(){return this._phone},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscribedNewsletters",{get:function(){return this._subscribedNewsletters},enumerable:!1,configurable:!0}),e.prototype.isSubscribedToNewsletter=function(e){return-1!==this._subscribedNewsletters.indexOf(e)},Object.defineProperty(e.prototype,"rawData",{get:function(){return this._rawData},enumerable:!1,configurable:!0}),e}(),D=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),R=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="InvalidCacheItemError",o}return D(t,e),t}(i),F=function(){function e(e,t,r,o){this._fresh=null,this._key=e,this._value=t,this._createdAt=o||new Date,this._expireAt=r}return Object.defineProperty(e.prototype,"key",{get:function(){return this._key},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"createdAt",{get:function(){return this._createdAt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"createdAtTimestamp",{get:function(){return Math.round(this._createdAt.getTime()/1e3)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"expireAt",{get:function(){return this._expireAt},set:function(e){this._expireAt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fresh",{set:function(e){this._fresh=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ttl",{get:function(){var e=new Date,t=Math.floor((this.expireAt.getTime()-e.getTime())/1e3);return 0>t?0:t},enumerable:!1,configurable:!0}),e.createFromJson=function(t,r){var o;try{o=p.parseJson(r)}catch(e){throw new R("JSON decode failed with error: "+e.message)}if(!Object.prototype.hasOwnProperty.call(o,"value")||!Object.prototype.hasOwnProperty.call(o,"ttl")||!Object.prototype.hasOwnProperty.call(o,"created_at"))throw new R('Cache item "'+r+"\" doesn't have expected structure.");if(!p.isInt(o.created_at)||!p.isInt(o.ttl))throw new R('Cache item "'+r+'" is invalid.');return new e(t,o.value,new Date(1e3*o.ttl),new Date(1e3*o.created_at))},e.prototype.toJson=function(){var e={created_at:this.createdAtTimestamp,ttl:Math.round(this._expireAt.getTime()/1e3),value:this._value};return JSON.stringify(e)},e.prototype.isFresh=function(){return null!==this._fresh?this._fresh:this.ttl>0},e}(),B=function(){function e(){this.logger=null}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.getCacheItem=function(e,t){void 0===t&&(t=null),this.log('getCacheItem("'+e+'")');try{var r=localStorage.getItem(e);if(!r)return this.log('Cache item "'+e+'" not found in localStorage.'),t;var o=F.createFromJson(e,r);return this.log("cacheItem loaded",F),o}catch(r){return this.log('Loading cache item "'+e+'" failed with error: '+r.message),localStorage.removeItem(e),t}},e.prototype.setCacheItem=function(e){this.log("setCacheItem()",e),localStorage.setItem(e.key,e.toJson())},e.prototype.get=function(e,t){void 0===t&&(t=null),this.log('get("'+e+'")');var r=this.getCacheItem(e,t);return null===r?t:r.isFresh()?r.value:(this.log('cache with key "'+e+'" is not fresh'),t)},e.prototype.set=function(e,t,r){this.log('set("'+e+'", ttl: '+r+")",t);var o=new Date,n=new F(e,t,new Date(o.getTime()+1e3*r),o);this.setCacheItem(n)},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("LocalStorageCache",e,t)},e}(),M=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),J=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="IframeError",o}return M(t,e),t}(i),N=r(2),W=function(){function e(e,t){this._response=null,this._messageId=e,this._resolvePromise=t}return Object.defineProperty(e.prototype,"messageId",{get:function(){return this._messageId},enumerable:!1,configurable:!0}),e.prototype.resolveResponse=function(e){this._response=e,this._resolvePromise(e)},Object.defineProperty(e.prototype,"response",{get:function(){return this._response},enumerable:!1,configurable:!0}),e}(),q=function(){function e(e){this.iframeIdentity="",this.iframeElement=null,this.logger=null,this.iframeUrl=e,this.messages=new Map}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.destroy=function(){this.messages=new Map,this.iframeElement&&this.iframeElement.parentNode&&this.iframeElement.parentNode.removeChild(this.iframeElement),this.iframeElement=null},e.prototype.lazyDestroy=function(){var e=this;0===this.messages.size&&setTimeout((function(){e.destroy()}),600)},e.prototype.sendMessage=function(e,t){var r=this;return this.log('sendMessage("'+e+'", '+t+")"),Object(N.timeout)(new Promise((function(t,o){r.initIframe().then((function(){if(r.log("iframe ready"),!r.iframeElement||!r.iframeElement.contentWindow)throw new J("Invalid state - the iframe should be initialized.");r.log('sending message: "'+e+'"');var o=new W(e,t);r.messages.set(e,o),r.iframeElement.contentWindow.postMessage(e,r.getIframeIdentity()),r.log("waiting for response")})).catch((function(e){r.log("rejected",e),o(e)}))})),t)},e.prototype.getIframeIdentity=function(){if(this.iframeIdentity)return this.iframeIdentity;var e=this.iframeUrl.match(/https?:\/\/[^/]+/);return null!==e&&(this.iframeIdentity=e[0]),this.iframeIdentity},e.prototype.initIframe=function(){var e=this;return this.log("initIframe()"),new Promise((function(t,r){if(null===e.iframeElement)try{e.log("Creating iframe in DOM with url: "+e.iframeUrl),e.iframeElement=document.createElement("iframe"),e.iframeElement.setAttribute("style","width:0; height:0; border:0; border:none"),e.iframeElement.setAttribute("src",e.iframeUrl),e.iframeElement.addEventListener("load",(function(){t()})),window.addEventListener("message",e.onReceiveMessage.bind(e),!1),document.body.appendChild(e.iframeElement),e.log("Creating iframe in DOM done")}catch(t){e.log("Creating iframe in DOM failed with message: "+t.message),r(t)}else t()}))},e.prototype.onReceiveMessage=function(e){if(this.log("onReceiveMessage()",e),e.origin===this.getIframeIdentity()){var t,r=e.data.indexOf(":"),o=null;r<=0?t=e.data:(t=e.data.substr(0,r),o=e.data.substr(r+1));var n=this.messages.get(t);n?(this.messages.delete(t),n.resolveResponse(o),this.log('messageId resolved with data "'+o+'"')):this.log('Unknown messageId "'+t)}else this.log('Message ignored, unknown identity "'+e.origin+'", "'+this.getIframeIdentity()+'" expected')},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("SharedLocalStorage",e,t)},e}(),z=function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function o(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(o.prototype=r.prototype,new o)}}(),H=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var o=e.apply(this,t)||this;return o.stack=new Error(t[0]).stack,o.name="UserDataLoadFailedError",o}return z(t,e),t}(l),V=function(){function e(e){this.reloadPromiseStatus="init",this.reloadPromise=null,this.logger=null,this.sharedLs=null,this.localCacheItem=null,this.sharedCacheItem=null,this.user=null,this.config=e,this.lsCache=new B}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.loadUserData=function(e){var t=this;if(this.log("loadUserData()"),this.user=e,!this.config.userDataFetchUrl)throw new i('To load user data, please, specify "userDataFetchUrl" in config.');return this.reloadPromise&&this.isReloadPromiseUsable()?this.reloadPromise:new Promise((function(e,r){t.load(e,r)}))},e.prototype.reloadUserData=function(e){var t=this;return this.log("reloadUserData()"),this.user=e,this.localCacheItem=null,this.sharedCacheItem=null,new Promise((function(e,r){t.requestUserData(e,r)}))},e.prototype.isReloadPromiseUsable=function(){return"updating"===this.reloadPromiseStatus||"success"===this.reloadPromiseStatus&&!(!this.localCacheItem||!this.localCacheItem.isFresh())},e.prototype.load=function(e,t){var r=null;if(this.localCacheItem=this.lsCache.getCacheItem("sme_cl_user",null),this.localCacheItem&&this.localCacheItem.value&&this.isCacheItemFresh(this.localCacheItem)){var o=this.localCacheItem.value;if(this.log("Data in local storage found",o),r=S.createFromRawData(o),this.isValid(r))return this.log("Data in local storage accepted, resolved",o),this.pushToSharedLocalStorage(this.localCacheItem),void e(r);this.log("Data in local storage invalid")}else this.log("No fresh data found in local storage");this.config.sharedIframeUrl?this.processSharedIframeCache(e,t):this.requestUserData(e,t)},e.prototype.processSharedIframeCache=function(e,t){var r=this;this.log("try to find data in shared storage"),this.getSharedLs().sendMessage("sme_cl.getUserData",1e3).then((function(o){try{if(r.sharedCacheItem=F.createFromJson("sme_cl_user",o),r.isCacheItemFresh(r.sharedCacheItem)){var n=S.createFromRawData(r.sharedCacheItem.value);if(r.isValid(n))return r.log("Data from shared local storage accepted, resolved",r.sharedCacheItem.value),r.localCacheItem=r.sharedCacheItem,r.lsCache.setCacheItem(r.sharedCacheItem),void e(n)}}catch(o){return r.log("Creating cache item from shared ls data failed with error: "+o.message),void r.requestUserData(e,t)}})).catch((function(o){r.log("shared local storage failed with error: "+o.message),r.requestUserData(e,t)}))},e.prototype.requestUserData=function(e,t){var r=this;this.reloadPromiseStatus="updating",this.reloadPromise=this.fetchFromServer(),this.reloadPromise.then((function(t){r.reloadPromiseStatus="success",r.localCacheItem=new F("sme_cl_user",t.rawData,r.getCurrentExpireAt(1800)),r.lsCache.setCacheItem(r.localCacheItem),r.pushToSharedLocalStorage(r.localCacheItem),e(t)})).catch((function(o){if(r.reloadPromiseStatus="error",r.sharedCacheItem){var n=S.createFromRawData(r.sharedCacheItem.value);if(r.isValid(n))return r.log("Outdated data from shared local storage accepted, resolved",n),r.sharedCacheItem.expireAt=r.getCurrentExpireAt(3600),r.localCacheItem=r.sharedCacheItem,r.lsCache.setCacheItem(r.sharedCacheItem),r.pushToSharedLocalStorage(r.sharedCacheItem),void e(n)}if(r.localCacheItem&&(n=S.createFromRawData(r.localCacheItem.value),r.isValid(n)))return r.log("Outdated data from local storage accepted, resolved",n),r.localCacheItem.expireAt=r.getCurrentExpireAt(3600),r.lsCache.setCacheItem(r.localCacheItem),r.pushToSharedLocalStorage(r.localCacheItem),void e(n);t(new H('Loading UserData failed with error "'+o.message+'".'))}))},e.prototype.isValid=function(e){return e.id?!this.user||this.user.id===e.id||(this.log('Data in local storage belongs to user "'+e.id+'", but currently logged in user is "'+this.user.id+'".'),!1):(this.log("Data in local storage are invalid"),!1)},e.prototype.getSharedLs=function(){if(!this.config.sharedIframeUrl)throw new i("Invalid state, sharedIframeUrl should be defined in config");return null===this.sharedLs&&(this.sharedLs=new q(this.config.sharedIframeUrl)),this.logger&&this.sharedLs.setLogger(this.logger),this.sharedLs},e.prototype.pushToSharedLocalStorage=function(e){var t=this;this.config.sharedIframeUrl&&this.getSharedLs().sendMessage("sme_cl.setUserData:"+e.toJson(),2e3).then((function(){t.log("sharedLs success")})).catch((function(){t.log("sharedLs error")}))},e.prototype.getCurrentExpireAt=function(e){var t=new Date;return new Date(t.getTime()+1e3*e)},e.prototype.fetchFromServer=function(){var e=this;if(this.log("fetchFromServer()"),!this.config.userDataFetchUrl)throw new i('Invalid state. "userDataFetchUrl" should be configured.');return new Promise((function(t,r){if(!e.user)throw new i("Invalid state. Unknown user.");if(!e.config.userDataFetchUrl)throw new i('Invalid state. "userDataFetchUrl" should be configured.');try{var o=new XMLHttpRequest;o.ontimeout=function(){return e.onTimeout(r)},o.onerror=function(){return e.onError(o,r)},o.onload=function(){200===o.status?e.onSuccess(o,t,r):e.onError(o,r)};var n=e.config.userDataFetchUrl.replace("{userId}",e.user.id.toString());o.open("GET",n,!0),o.timeout=7e3,o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Content-Type","application/json"),o.withCredentials=!0,o.send(),e.log("Ajax request to "+n)}catch(e){r(e)}}))},e.prototype.onSuccess=function(e,t,r){this.log("Ajax success",e);var o=e.responseText;if(o){var n=S.createFromRawData(this.parseJson(o));if(this.isValid(n))return this.log("Data from ajax accepted, resolved",n),void t(n)}this.log("Invalid data in json response."),r(new H("Invalid response from server: "+o))},e.prototype.onTimeout=function(e){this.log("Ajax failed with timeout."),e(new H("HTTP API timeout"))},e.prototype.onError=function(e,t){this.log("Ajax error. Response status code: "+e.status),t(new H("HTTP API Error"))},e.prototype.parseJson=function(e){try{return p.parseJson(e)}catch(e){throw new H("JSON parsing failed with error: "+e.message)}},e.prototype.isCacheItemFresh=function(e){if(!e.isFresh())return!1;if(this.user){if(this.isChangeCookieAccepted(e,"pwall_change"))return e.fresh=!1,!1;if(this.isChangeCookieAccepted(e,"sme_nl_change"))return e.fresh=!1,!1}return!0},e.prototype.isChangeCookieAccepted=function(e,t){if(!this.user)return!1;var r=k.get(t);if(r)try{var o=r.split("_"),n=p.toInt(o[0]),i=p.toInt(o[1]);if(i&&this.user.id===n&&e.createdAtTimestamp<=i+10)return this.log('Cookie "'+t+'" accepted. User data changed, should be refreshed.'),!0}catch(e){this.log('Error occurred during resolving value of "'+t+'" cookie: '+e.message)}return!1},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("UserDataLoader",e,t)},e}(),X=function(){function e(e){this.loader=null,this.logger=null,this.userPayload=null,this.user=null,this.userDataLoader=null,this.config=new L(e),this.log("Central instance created",this.config),this.config.refreshOnFocus&&(this.log("add window.onFocus() listener"),window.addEventListener("focus",this.onWindowFocus.bind(this)))}return e.prototype.setLogger=function(e){this.logger=e},e.prototype.getUser=function(){var e=this;return this.log("getUser()"),new Promise((function(t,r){null!==e.user&&null!==e.userPayload&&e.userPayload.isFresh()&&(e.log("resolved from local cache"),t(e.user)),e.log("calling loader"),e.getLoader().loadToken().then((function(r){if(e.loadUserFromUserPayload(r),null===e.user)throw new i("Unexpected state - User should be converted from userPayload");e.log("resolved",e.user),e.planToRefreshToken(),t(e.user)})).catch((function(t){e.log("rejected",t),r(t)}))}))},e.prototype.refreshUser=function(){var e=this;return this.log("refreshUser()"),new Promise((function(t,r){e.getLoader().refreshToken().then((function(r){if(e.log("resolved",r),e.loadUserFromUserPayload(r),null===e.user)throw new i("Unexpected state - User should be converted from userPayload");e.log("created user",e.user),e.planToRefreshToken(),t(e.user)})).catch((function(t){e.log("rejected",t),r(t)}))}))},e.prototype.getUserData=function(){var e=this.getUserDataLoader();if(!this.user)throw new i("No user found. Call `getUser()` first.");return e.loadUserData(this.user)},e.prototype.refreshUserData=function(){var e=this.getUserDataLoader();if(!this.user)throw new i("No user found. Call `getUser()` first.");return e.reloadUserData(this.user)},e.prototype.onWindowFocus=function(){var e=this;this.log("onWindowFocus()"),this.config.refreshOnFocus?null!==this.userPayload?this.userPayload.isFresh()?this.log("userPayload in cache is fresh",this.userPayload):(this.log("calling loader"),this.getLoader().loadToken().then((function(t){if(e.loadUserFromUserPayload(t),null===e.user)throw new i("Unexpected state - User should be converted from userPayload");e.log("user loaded successfully",e.user),e.planToRefreshToken()})).catch((function(t){e.log("error loading user",t)}))):this.log("no userPayload, onWindowFocus() ignored",this.userPayload):this.log("refreshBeforeExpire disabled, onWindowFocus() ignored")},e.prototype.clearCache=function(){this.log("clearCache()"),this.user=null,this.userPayload=null,this.getLoader().clearCache()},e.prototype.getLoader=function(){return null!==this.loader?this.loader:this.config.shareTokenLoader&&Object.prototype.hasOwnProperty.call(window,"_smeCentralTokenLoader_v0_5")&&window._smeCentralTokenLoader_v0_5?(this.log("Used tokenLoader from other Central instance"),this.loader=window._smeCentralTokenLoader_v0_5,this.loader):(this.log("Creating instance of TokenLoader"),this.loader=new A(this.config),null!==this.logger&&this.loader.setLogger(this.logger),this.config.shareTokenLoader&&(window._smeCentralTokenLoader_v0_5=this.loader,this.log("Publish TokenLoader to be used by other Central lib instances")),this.loader)},e.prototype.getUserDataLoader=function(){return this.userDataLoader||(this.userDataLoader=new V(this.config)),this.userDataLoader},e.prototype.log=function(e,t){null!==this.logger&&this.logger.debug("Main",e,t)},e.prototype.planToRefreshToken=function(){var e=this;if(this.log("planToRefreshToken()"),this.config.refreshBeforeExpire)if(null!==this.userPayload){var t,r=this.userPayload.ttl;this.log("token ttl: "+r),r>this.config.refreshTokenPeriodBeforeExpire?(t=r-this.config.refreshTokenPeriodBeforeExpire,this.log("token will expire in the future, refresh it after "+t+" seconds")):(this.log("token will expire soon, refresh it ASAP"),t=0),this.getLoader().refreshTokenAfter(t).then((function(t){e.loadUserFromUserPayload(t),e.planToRefreshToken(),e.log("resolved",e.user)}))}else this.log("no userPayload, ignored",this.userPayload);else this.log("refreshBeforeExpire disabled, planToRefreshToken() ignored")},e.prototype.loadUserFromUserPayload=function(e){this.userPayload=e,this.user=new u(p.toInt(this.userPayload.subject),this.userPayload.email,this.userPayload.confirmed,this.userPayload.subscriptionRoles)},e}(),K=function(){function e(e){e||(e="Central_"+Math.random().toString(36).substr(2,5)),this.instanceId=e}return e.prototype.debug=function(e,t,r){this.log("debug",e,t,r)},e.prototype.log=function(e,t,r,o){if(r="["+this.instanceId+"] [Sme/Central/"+t+"] "+r,o)switch(e){case"error":console.error(r,o);break;case"warn":console.warn(r,o);break;case"info":console.info(r,o);break;case"debug":default:console.debug(r,o)}else switch(e){case"error":console.error(r);break;case"warn":console.warn(r);break;case"info":console.info(r);break;case"debug":default:console.debug(r)}},e}()}])},"4yiq":function(e,t,r){"use strict";function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(t,"__esModule",{value:!0});var n=r("0/Wv"),i=r("dklh"),a=function(){function e(){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.central=null,this.centralUser=null,this.ui=null,window.smeCorpBarConfig.uiEnabled&&(this.ui=new i.default),this.cookieExists("ppu")){this.central=new n.Central({tokenUpdateUrl:window.smeCorpBarConfig.tokenUpdateUrl,userDataFetchUrl:window.smeCorpBarConfig.userDataFetchUrl,sharedIframeUrl:window.smeCorpBarConfig.sharedIframeUrl,waitTimeInCaseOfApiError:120,waitTimeInCaseOfApiTimeout:1200,refreshOnFocus:!0,refreshBeforeExpire:!0,refreshTokenPeriodBeforeExpire:250});var t=null;(0<window.location.hash.indexOf("PPSmeCentralDebugEnabled")||0<window.location.host.indexOf("localhost"))&&(t=new n.ConsoleLogger("Corpbar"),this.central.setLogger(t)),this.loadUser(t)}else{var r=new CustomEvent("smeClUserLoadError",{detail:"User is not logged in."});document.body.dispatchEvent(r)}}var t,r,a;return t=e,(r=[{key:"loadUser",value:function(e){var t=this;this.central.getUser().then((function(r){null!==e&&e.log("info","[SmeCorpBar]","JWT resolved",r),t.centralUser=r,t.ui&&(r.email&&t.ui.showAuthenticated(r),t.central.getUserData().then((function(e){t.ui&&t.ui.displayInfoAboutSubscription(e.rawData),document.body.dispatchEvent(new CustomEvent("smeClUserLoaded",{detail:e.rawData}))})).catch((function(e){console.error("[SmeCorpBar] Loading user data failed with error: "+e.message);var t=new CustomEvent("smeClUserLoadError",{detail:e.message});document.body.dispatchEvent(t)})))})).catch((function(t){null!==e&&e.log("error","[SmeCorpBar]","Loading user info failed with error: "+t.message,t),"User is not logged in."!==t.message&&console.error("[SmeCorpBar] Loading user info failed with error: "+t.message),document.body.dispatchEvent(new CustomEvent("smeClUserLoadError",{detail:t.message}))}))}},{key:"cookieExists",value:function(e){return 0===document.cookie.indexOf("".concat(e,"="))||-1!==document.cookie.indexOf("; ".concat(e,"="))||-1!==document.cookie.indexOf(";".concat(e,"="))}}])&&o(t.prototype,r),a&&o(t,a),e}();t.default=a},bcKa:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),new(r("4yiq").default)},dklh:function(e,t,r){"use strict";function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.initializedLoginPopup=!1,this.initializedProfilePopup=!1,this.changeSubscriptionHrefs(),this.init(),window.sme_cl_login=function(){t.showLoginForm()},window.sme_cl_showDropdown=function(){console.warn("[SmeCorpBar] calling `sme_cl_showDropdown()` id deprecated. This method will be removed soon. Use `sme_cl_login()` instead."),t.showLoginForm()},window.location.hash&&"#login"===window.location.hash&&this.showLoginForm(),window.smeCorpBar={},window.smeCorpBar.addCurrentUrlAsTargetUrlParam=function(e){return t.addCurrentUrlAsTargetUrlParam(e)}}var t,r,n;return t=e,(r=[{key:"showAuthenticated",value:function(e){var t=e.email;!e.confirmed&&t&&this.showUnconfirmedUserWarning(t);var r=document.getElementById("js-sme-corpbar-user-logged");r&&r.classList.remove("is-hidden");var o=document.getElementById("js-sme-corpbar-user-unlogged");o&&o.classList.add("is-hidden");var n=document.getElementById("js-sme-corpbar-user-username");n&&t&&(n.innerText=t),this.initializeProfilePopup()}},{key:"showUnconfirmedUserWarning",value:function(e){var t=document.getElementById("sme-corpbar");if(t){var r=t.parentElement;if(r){var o=document.createElement("div");o.classList.add("sme-banner-user-unconfirmed"),o.setAttribute("data-email",e),r.prepend(o)}}}},{key:"displayInfoAboutSubscription",value:function(e){if(e.subscription.active)if(this.displayRemainingSubscriptionTime(e)&&e.info&&!e.info.subscription.is_content_access_web_recurrent){var t=document.getElementById("js-corpbar-prolong-subscription");t&&t.classList.remove("is-hidden")}else{var r=document.getElementById("js-corpbar-donate-subscription");r&&r.classList.remove("is-hidden")}else{var o=document.getElementById("js-corpbar-no-subscription");o&&o.classList.remove("is-hidden")}}},{key:"init",value:function(){var e=this,t=document.getElementById("js-sme-corpbar-user-login-email");t&&t.addEventListener("focus",(function(){var e=document.getElementById("js-sme-corpbar-user-passwordWrapper");e&&e.classList.remove("is-hidden")}),{once:!0}),document.body.addEventListener("click",this.hideDropdown);var r=document.getElementById("js-user-login-popup");r&&r.addEventListener("click",(function(e){e.stopPropagation()}));var o=document.getElementById("js-sme-home");o&&o.addEventListener("click",(function(t){e.showMobileDropdown("js-sme-corpbar-mobile")}));var n=document.getElementById("js-sme-user-logged");n&&n.addEventListener("click",(function(t){e.showMobileDropdown("js-user-logged-popup"),t.stopPropagation()}));var i=document.getElementById("js-sme-user");i&&i.addEventListener("click",(function(t){e.toggleDropDown("js-user-login-popup"),t.stopPropagation()})),this.initLoadingCsrfToken()}},{key:"initLoadingCsrfToken",value:function(){var e=this,t=!1,r=document.getElementById("js-sme-corpbar-user-login-form");r&&(r.onsubmit=function(o){var n=document.getElementById("js-sme-corpbar-user-login-form-token");return!t&&n&&""===n.value&&(t=!0,o.preventDefault(),e.doAjax(window.smeCorpBarConfig.loginCsrfTokenApiEndpoint,(function(e){n.value=e,r&&r.submit()}))),!0})}},{key:"isHidden",value:function(e){return"none"===window.getComputedStyle(e).display}},{key:"toggleDropDown",value:function(e){var t=document.getElementById(e);if(!t)throw new Error("Element with ID ".concat(e," does not exist."));var r=this.isHidden(t);this.hideServicesSubmenu(),this.hideNewsSubmenu(),this.hideMobileCorpbar();var o=document.getElementById("js-sme-corpbar-user-login-email");o&&o.blur(),r?(t.classList.add("is-visible"),t.classList.remove("is-hidden")):(t.classList.add("is-hidden"),t.classList.remove("is-visible")),this.initializeLoginPopup()}},{key:"hideMobileCorpbar",value:function(){var e=document.getElementById("js-sme-corpbar-mobile");e&&e.classList.remove("is-visible")}},{key:"hideServicesSubmenu",value:function(){var e=document.getElementById("js-services");null!==e&&e.classList.remove("is-visible")}},{key:"hideNewsSubmenu",value:function(){if(null!==document.getElementById("js-news")){var e=document.getElementById("js-news");e&&e.classList.remove("is-visible")}}},{key:"showMobileDropdown",value:function(e){window.matchMedia("(max-width: 991px)").matches&&this.toggleDropDown(e)}},{key:"hideDropdown",value:function(){var e=document.getElementById("js-user-login-popup");e&&e.classList.remove("is-visible");var t=document.getElementById("js-user-logged-popup");t&&t.classList.remove("is-visible")}},{key:"doAjax",value:function(e,t){var r=new XMLHttpRequest;r.onreadystatechange=function(){4==r.readyState&&200==r.status&&t(r.responseText)},r.open("GET",e,!0),r.withCredentials=!0,r.send()}},{key:"addCurrentUrlAsTargetUrlParam",value:function(e){return-1!==e.indexOf("?url=")||-1!==e.indexOf("&url=")?e:(-1!==e.indexOf("?")?e+="&":e+="?",e+"url="+encodeURIComponent(window.location.href))}},{key:"initializeLoginPopup",value:function(){var e=this;if(!this.initializedLoginPopup){this.initializedLoginPopup=!0,document.querySelectorAll(".js-sme-corpbar-append-target-url").forEach((function(t){t.href=e.addCurrentUrlAsTargetUrlParam(t.href)}));var t=document.getElementById("js-sme-corpbar-user-login-form");t.action=this.addCurrentUrlAsTargetUrlParam(t.action)}}},{key:"initializeProfilePopup",value:function(){if(!this.initializedProfilePopup){this.initializedProfilePopup=!0;var e=document.getElementById("js-sme-corpbar-user-logout");e.href=this.addCurrentUrlAsTargetUrlParam(e.href)}}},{key:"displayRemainingSubscriptionTime",value:function(e){var t=!1;if(e.info&&!e.info.subscription.is_content_access_web_recurrent&&e.info&&e.info.subscription.content_access_group_end_time){var r=Date.parse(e.info.subscription.content_access_group_end_time);isNaN(r)||(t=this.displayRemainingTimeInfo(Math.round(r/1e3)))}return t}},{key:"displayRemainingTimeInfo",value:function(e){if(isNaN(e))return!1;var t=e-Math.round((new Date).getTime()/1e3);if(t<=59)return!1;var r=Math.floor(t/60),o=Math.floor(r/60),n=Math.floor(o/24);if(n>7)return!1;var i=document.getElementById("js-corpbar-remaining-subscription-time");if(!i)return!1;var a="",s=0;return n>5?(a=i.dataset.daysMore,s=n):n>1?(a=i.dataset.days,s=n):n>0?(a=i.dataset.day,s=n):o>5?(a=i.dataset.hoursMore,s=o):o>1?(a=i.dataset.hours,s=o):o>0?(a=i.dataset.hour,s=o):r>5||r<=0?(a=i.dataset.minutesMore,s=r):r>1?(a=i.dataset.minutes,s=r):r>0&&(a=i.dataset.minute,s=r),i.innerHTML=a.replace("%value%",s.toString())+"&nbsp;",!0}},{key:"changeSubscriptionHrefs",value:function(){var e=document.querySelectorAll(".js-subscription-button"),t=window.location.hostname;if(e&&!(t.indexOf("korzar.sme")<0&&t.indexOf("spectator.sme")<0)){var r="";t.indexOf("korzar.sme")>=0&&(r=window.smeCorpBarConfig.buySubscriptionUrlKorzar),t.indexOf("spectator.sme")>=0&&(r=window.smeCorpBarConfig.buySubscriptionUrlSpectator),e.forEach((function(e){e.href=r}))}}},{key:"showLoginForm",value:function(){var e=document.getElementById("js-sme-user");e&&e.scrollIntoView(),this.toggleDropDown("js-user-login-popup")}}])&&o(t.prototype,r),n&&o(t,n),e}();t.default=n}});